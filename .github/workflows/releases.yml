name: Release to PyPI and GitHub

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*.*.*'  # Only triggers on version tags

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      # Install all dev dependencies in a virtual environment
      - name: Install uv and dev dependencies
        run: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo "$HOME/.local/bin" >> $GITHUB_PATH
            uv sync --dev

      # Get release notes from CHANGELOG.md
      - name: Extract changelog
        id: changelog
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          NOTES=$(awk "/## \[${TAG}\]/,/^## \[/" CHANGELOG.md | sed '$d')
          echo "notes<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Build package using uv environment (hatch)
      - name: Build package
        run: uv build

      # Publish to PyPI
      - name: Upload to PyPI
        run: uv run twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: ${{ env.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
